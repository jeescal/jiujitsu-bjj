/* === CONFIGURACIÓN DE TRADUCCIONES === */
const translations = {
    es: {
        nav_home: "Inicio",
        nav_about: "Quiénes Somos",
        nav_gallery: "Galería",
        nav_events: "Eventos",
        nav_contact: "Contacto",
        hero_title: "JIUJITSU BRASILEÑO EN WINNIPEG",
        hero_subtitle: "Disciplina, Respeto y Comunidad",
        hero_cta: "Únete a Nosotros",
        about_title: "De Padres a Maestros: Nuestra Historia",
        about_content: `<p>Kinesis nació de algo muy simple y poderoso: el deseo de un grupo de amigos de transmitir el amor por las artes marciales a sus hijos. Lo que comenzó como un proyecto familiar para enseñar a Rodrigo (practicante de Jiujitsu desde los 7 años) y a Salvador (practicante de Aikido desde los 6 años), pronto se transformó en un sueño más grande: compartir esta pasión con toda la comunidad de Winnipeg.</p>
                        <p>Nuestras raíces vienen de Chile, donde Francisco Bugueño, nuestro instructor principal, fundó el Club Cinesis. Francisco es Cinturón Negro en Jiujitsu Brasileño con más de 25 años de experiencia en el tatami. Hoy, en tierras canadienses, une fuerzas con Juan Escalona, Cinturón Negro en Aikido con 15 años de trayectoria, para dar vida al Club de Jiujitsu Kinesis.</p>
                        <p>Nuestra misión es clara: queremos que el deporte sea accesible para todos en Winnipeg. Creemos que el Jiujitsu es una herramienta de crecimiento personal que debe estar al alcance de cualquier persona.</p>
                        <p>Actualmente, tenemos el honor de entrenar en las instalaciones de la Asociación Chilena de Manitoba, quienes nos han abierto sus puertas para seguir cultivando y expandiendo esta noble disciplina.</p>`,
        schedule_title: "Horarios",
        schedule_box_heading: "Horario Semanal de Clases",
        day_tuesday: "Martes:",
        day_thursday: "Jueves:",
        schedule_soon: "**Próximamente:** Sábados en la mañana",
        schedule_cta_text: "¿Listo para empezar tu viaje en el BJJ?",
        schedule_cta_btn: "¡Reserva tu Clase de Prueba Gratuita!",
        gallery_title: "Galería",
        events_title: "Próximos Eventos",
        event1_title: "Seminario de Apertura",
        event1_desc: "Clase especial con todos los alumnos.",
        contact_title: "Contáctanos",
        contact_btn: "Enviar Mensaje",
        chat_welcome: "¡Oss! ¿En qué puedo ayudarte? Pregunta por técnicas, horarios o ubicación.",
        chat_placeholder: "Escribe aquí...",
        chat_unknown: "Lo siento, no entiendo esa pregunta.",
        chat_suggestion_intro: "Quizás te interese preguntar por: " // NUEVA CLAVE
    },
    en: {
        nav_home: "Home",
        nav_about: "About Us",
        nav_gallery: "Gallery",
        nav_events: "Events",
        nav_contact: "Contact",
        hero_title: "BRAZILIAN JIUJITSU IN WINNIPEG",
        hero_subtitle: "Discipline, Respect and Community",
        hero_cta: "Join Us",
        about_title: "From Parents to Masters: Our Story",
        about_content: `<p>Kinesis was born from something very simple and powerful: the desire of a group of friends to pass on their love for martial arts to their children. What started as a family project to teach Rodrigo (Jiujitsu practitioner since age 7) and Salvador (Aikido practitioner since age 6), soon transformed into a bigger dream: sharing this passion with the entire Winnipeg community.</p>
                        <p>Our roots come from Chile, where Francisco Bugueño, our head instructor, founded Club Cinesis. Francisco is a Black Belt in Brazilian Jiujitsu with over 25 years of experience on the mats. Today, in Canadian lands, he joins forces with Juan Escalona, Aikido Black Belt with 15 years of experience, to bring Kinesis Jiujitsu Club to life.</p>
                        <p>Our mission is clear: we want sports to be accessible to everyone in Winnipeg. We believe Jiujitsu is a tool for personal growth that should be within anyone's reach.</p>
                        <p>We currently have the honor of training at the Manitoba Chilean Association facilities, who have kindly opened their doors for us to continue cultivating and expanding this noble discipline.</p>`,
        schedule_title: "Schedule",
        schedule_box_heading: "Weekly Class Schedule",
        day_tuesday: "Tuesday:",
        day_thursday: "Thursday:",
        schedule_soon: "**Coming Soon:** Saturday mornings",
        schedule_cta_text: "Ready to start your BJJ journey?",
        schedule_cta_btn: "Book Your Free Trial Class!",
        gallery_title: "Gallery",
        events_title: "Upcoming Events",
        event1_title: "Opening Seminar",
        event1_desc: "Special class with all students.",
        contact_title: "Contact Us",
        contact_btn: "Send Message",
        chat_welcome: "Oss! How can I help you? Ask about techniques, schedule, or location.",
        chat_placeholder: "Type here...",
        chat_unknown: "Sorry, I don't understand that question.",
        chat_suggestion_intro: "You might be interested in asking about: " // NUEVA CLAVE
    },
    fr: {
        nav_home: "Accueil",
        nav_about: "À Propos",
        nav_gallery: "Galerie",
        nav_events: "Événements",
        nav_contact: "Contact",
        hero_title: "JIUJITSU BRÉSILIEN À WINNIPEG",
        hero_subtitle: "Discipline, Respect et Communauté",
        hero_cta: "Rejoignez-nous",
        about_title: "De Parents à Maîtres : Notre Histoire",
        about_content: `<p>Kinesis est né de quelque chose de très simple et puissant : le désir d'un groupe d'amis de transmettre leur amour des arts martiaux à leurs enfants. Ce qui a commencé comme un projet familial pour enseigner à Rodrigo (pratiquant de Jiujitsu depuis l'âge de 7 ans) et Salvador (pratiquant d'Aïkido depuis l'âge de 6 ans), s'est vite transformé en un rêve plus grand : partager cette passion avec toute la communauté de Winnipeg.</p>
                        <p>Nos racines viennent du Chili, où Francisco Bugueño, notre instructeur principal, a fondé le Club Cinesis. Francisco est Ceinture Noire de Jiujitsu Brésilien avec plus de 25 ans d'expérience sur le tatami. Aujourd'hui, sur les terres canadiennes, il s'associe à Juan Escalona, Ceinture Noire d'Aïkido avec 15 ans d'expérience, pour donner vie au Club de Jiujitsu Kinesis.</p>
                        <p>Notre mission est claire : nous voulons que le sport soit accessible à tous à Winnipeg. Nous croyons que le Jiujitsu est un outil de développement personnel qui devrait être à la portée de tous.</p>
                        <p>Actuellement, nous avons l'honneur de nous entraîner dans les installations de l'Association Chilienne du Manitoba, qui nous ont ouvert leurs portes pour continuer à cultiver et développer cette noble discipline.</p>`,
        schedule_title: "Horaires",
        schedule_box_heading: "Horaire Hebdomadaire de Cours",
        day_tuesday: "Mardi:",
        day_thursday: "Jeudi:",
        schedule_soon: "**Bientôt:** Samedis matin",
        schedule_cta_text: "Prêt à commencer votre parcours BJJ?",
        schedule_cta_btn: "Réservez Votre Cours d'Essai Gratuit!",
        gallery_title: "Galerie",
        events_title: "Événements à Venir",
        event1_title: "Séminaire d'Ouverture",
        event1_desc: "Cours spécial avec tous les élèves.",
        contact_title: "Contactez-nous",
        contact_btn: "Envoyer Message",
        chat_welcome: "Oss! Comment puis-je vous aider? Demandez des techniques, l'horaire ou l'emplacement.",
        chat_placeholder: "Écrivez aquí...",
        chat_unknown: "Désolé, je ne comprends pas.",
        chat_suggestion_intro: "Peut-être voudriez-vous poser des questions sur : " // NUEVA CLAVE
    },
    pt: {
        nav_home: "Início",
        nav_about: "Quem Somos",
        nav_gallery: "Galeria",
        nav_events: "Eventos",
        nav_contact: "Contato",
        hero_title: "JIUJITSU BRASILEIRO EM WINNIPEG",
        hero_subtitle: "Disciplina, Respeito e Comunidade",
        hero_cta: "Junte-se a Nós",
        about_title: "De Pais a Mestres: Nossa História",
        about_content: `<p>A Kinesis nasceu de algo muito simples e poderoso: o desejo de um grupo de amigos de transmitir o amor pelas artes marciais aos seus filhos. O que começou como um projeto familiar para ensinar Rodrigo (praticante de Jiujitsu desde os 7 anos) e Salvador (practicante de Aikido desde os 6 anos), logo se transformou em um sonho maior: compartilhar essa paixão com toda a comunidade de Winnipeg.</p>
                        <p>Nossas raízes vêm do Chile, onde Francisco Bugueño, nosso instrutor principal, fundou o Club Cinesis. Francisco é Faixa Preta em Jiujitsu Brasileiro com mais de 25 anos de experiência no tatame. Hoje, em terras canadenses, une forças com Juan Escalona, Faixa Preta em Aikido com 15 anos de trajetória, para dar vida ao Clube de Jiujitsu Kinesis.</p>
                        <p>Nossa missão é clara: queremos que o esporte seja acessível para todos em Winnipeg. Acreditamos que o Jiujitsu é uma ferramenta de crescimento personal que deve estar ao alcance de qualquer pessoa.</p>
                        <p>Atualmente, temos a honra de treinar nas instalações da Associação Chilena de Manitoba, que gentilmente nos abriram suas portas para continuar cultivando e expandindo esta nobre disciplina.</p>`,
        schedule_title: "Horários",
        schedule_box_heading: "Horário Semanal de Aulas",
        day_tuesday: "Terça-feira:",
        day_thursday: "Quinta-feira:",
        schedule_soon: "**Em Breve:** Sábados de manhã",
        schedule_cta_text: "Pronto para começar sua jornada no BJJ?",
        schedule_cta_btn: "Agende Sua Aula Experimental Gratuita!",
        gallery_title: "Galeria",
        events_title: "Próximos Eventos",
        event1_title: "Seminário de Abertura",
        event1_desc: "Aula especial com todos os alunos.",
        contact_title: "Contate-nos",
        contact_btn: "Enviar Mensagem",
        chat_welcome: "Oss! Como posso ajudar? Pergunte sobre técnicas, horários ou localização.",
        chat_placeholder: "Digite aquí...",
        chat_unknown: "Desculpe, não entendi.",
        chat_suggestion_intro: "Talvez você queira perguntar sobre: " // NUEVA CLAVE
    }
};

let currentLang = 'es';

// Función para cambiar idioma
function changeLanguage(lang) {
    currentLang = lang;
    const elements = document.querySelectorAll('[data-i18n]');
    
    elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            if (key === 'about_content') {
                el.innerHTML = translations[lang][key];
            } else {
                el.textContent = translations[lang][key];
            }
        }
    });

    // Actualizar placeholders y chatbot
    const placeholderText = translations[lang].chat_placeholder;
    if (placeholderText) {
        const userInput = document.getElementById('user-input');
        if (userInput) userInput.placeholder = placeholderText;
    }
    
    // Resetear Chat y mensaje de bienvenida
    const chatBody = document.getElementById('chatbot-body');
    if (chatBody) {
        chatBody.innerHTML = `<div class="bot-message" data-i18n="chat_welcome">${translations[lang].chat_welcome}</div>`;
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // Selector de Idioma
    const langSelect = document.getElementById('language-select');
    langSelect.addEventListener('change', (e) => {
        changeLanguage(e.target.value);
    });

    // Menú Móvil
    const menuToggle = document.querySelector('.menu-toggle');
    const navLinks = document.getElementById('nav-links');
    menuToggle.addEventListener('click', () => {
        navLinks.classList.toggle('active');
    });

    // Iniciar en español por defecto o por localStorage
    const savedLang = localStorage.getItem('kinesis_lang') || 'es';
    langSelect.value = savedLang;
    changeLanguage(savedLang);
    langSelect.addEventListener('change', (e) => {
        const newLang = e.target.value;
        localStorage.setItem('kinesis_lang', newLang);
        changeLanguage(newLang);
    });
    
    // INICIA LA CARGA DE LA BASE DE CONOCIMIENTO
    loadKnowledgeBase();
});

/* === CHATBOT LOGIC (CARGA ASÍNCRONA DE BASE DE CONOCIMIENTO) === */
let bjjKnowledge = {};

// Función para cargar la base de conocimiento desde el archivo JSON
async function loadKnowledgeBase() {
    try {
        const response = await fetch('data/knowledge.json'); 
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        bjjKnowledge = await response.json();
        console.log('Base de conocimiento del Chatbot cargada con éxito.');
    } catch (error) {
        console.error('Error al cargar la base de conocimiento JSON. Usando base vacía:', error);
        bjjKnowledge = {}; 
    }
}

// NUEVA FUNCIÓN: Genera una lista de sugerencias de técnicas
function getSuggestions(lang) {
    const suggestions = [];
    // Claves que son información de contacto/horario y no técnicas
    const nonTechniqueKeys = ['schedule', 'location']; 

    // Itera sobre la base de conocimiento cargada
    for (const key in bjjKnowledge) {
        // Si la clave no es de la lista de omisiones Y tiene una traducción en el idioma actual
        if (!nonTechniqueKeys.includes(key) && bjjKnowledge[key][lang]) {
            // Convierte las claves_con_guion_bajo a Claves Con Espacio (más amigable para sugerencias)
            const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            suggestions.push(displayKey);
        }
    }
    // Devuelve las primeras 8 sugerencias unidas por una coma
    return suggestions.slice(0, 8).join(', ');
}


const chatToggle = document.getElementById('chatbot-toggle');
const chatContainer = document.getElementById('chatbot-container');
const closeChat = document.getElementById('close-chat');
const sendBtn = document.getElementById('send-btn');
const userInput = document.getElementById('user-input');
const chatBody = document.getElementById('chatbot-body');

chatToggle.addEventListener('click', () => chatContainer.classList.add('active'));
closeChat.addEventListener('click', () => chatContainer.classList.remove('active'));

sendBtn.addEventListener('click', handleChat);
userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleChat();
});

function handleChat() {
    const text = userInput.value.toLowerCase().trim();
    if (!text) return;

    // Mostrar mensaje usuario
    addMessage(userInput.value, 'user-message');
    userInput.value = '';

    // Lógica simple de respuesta con keywords
    setTimeout(() => {
        let response = translations[currentLang].chat_unknown;
        let knowledgeKey = null;

        // 1. Definición de palabras clave y su mapeo a la clave JSON
        const keywordMap = {
            // Técnicas
            'guard': 'guard',
            'guardia': 'guard',
            'garde': 'guard',
            'guarda': 'guard',
            'closed guard': 'closed_guard',
            'guardia cerrada': 'closed_guard',
            'garde fermée': 'closed_guard',
            'guarda fechada': 'closed_guard',
            'half guard': 'half_guard',
            'media guardia': 'half_guard',
            'demi garde': 'half_guard',
            'meia guarda': 'half_guard',
            'butterfly': 'butterfly_guard',
            'mariposa': 'butterfly_guard',
            'papillon': 'butterfly_guard',
            'guard pass': 'guard_pass',
            'pasaje de guardia': 'guard_pass',
            'passage de garde': 'guard_pass',
            'passagem de guarda': 'guard_pass',
            'sweep': 'sweep',
            'raspado': 'sweep',
            'barrido': 'sweep',
            'balayage': 'sweep',
            'raspagem': 'sweep',
            'mount': 'mount',
            'montada': 'mount',
            'montée': 'mount',
            'side control': 'side_control',
            'control lateral': 'side_control',
            'controle lateral': 'side_control',
            'back control': 'back_control',
            'control de espalda': 'back_control',
            'controle do dos': 'back_control',
            'rnc': 'rear_naked_choke',
            'mata leon': 'rear_naked_choke',
            'mata-leon': 'rear_naked_choke',
            'rear naked choke': 'rear_naked_choke',
            'triangle': 'triangle_choke',
            'triangulo': 'triangle_choke',
            'armbar': 'armbar',
            'palanca de brazo': 'armbar',
            'chave de braço': 'armbar',
            'kimura': 'kimura',
            'americana': 'americana',
            'omoplata': 'omoplata',
            'omoplates': 'omoplata',
            'takedown': 'takedown',
            'derribo': 'takedown',
            'queda': 'takedown',

            // Información del Club
            'schedule': 'schedule',
            'horario': 'schedule',
            'horaire': 'schedule',
            'horários': 'schedule',
            'location': 'location',
            'ubicación': 'location',
            'emplacement': 'location',
            'localização': 'location'
        };

        // 2. Busca la palabra clave más larga en la entrada del usuario
        const sortedKeywords = Object.keys(keywordMap).sort((a, b) => b.length - a.length);

        for (const keyword of sortedKeywords) {
            if (text.includes(keyword)) {
                knowledgeKey = keywordMap[keyword];
                break; 
            }
        }
        
        // 3. Intenta obtener la respuesta de la base de conocimiento cargada
        if (knowledgeKey && bjjKnowledge[knowledgeKey] && bjjKnowledge[knowledgeKey][currentLang]) {
            response = bjjKnowledge[knowledgeKey][currentLang];
        } else {
            // Lógica de SUGERENCIA
            const suggestionList = getSuggestions(currentLang);
            // Combina el mensaje de desconocido con la lista de sugerencias
            response = translations[currentLang].chat_unknown + " " + translations[currentLang].chat_suggestion_intro + suggestionList + ".";
        }

        addMessage(response, 'bot-message');
        // Auto scroll
        chatBody.scrollTop = chatBody.scrollHeight;
    }, 500);
}

function addMessage(text, className) {
    const div = document.createElement('div');
    div.classList.add(className);
    div.textContent = text;
    chatBody.appendChild(div);
}
